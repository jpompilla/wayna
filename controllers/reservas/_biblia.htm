<div class="list-preview list-flush">
    <div class="control-list">
        <table class="table data" data-control="rowlink">
            <thead>
                <tr>
                    <th class="text-center" style="background-color: #dc573b;"><span style="color: #fff;">Biblia de Reservas</span></th>
                    <th class="text-center"><span>Nro Paxs</span></th>                
                    
                    <?php if (!empty($fechas) && is_array($fechas)): ?>
                    <?php foreach ($fechas as $fecha): ?>
                        <?php
                            try {
                                $d = new DateTime($fecha);
                                if (class_exists('IntlDateFormatter')) {
                                    $fmt = new \IntlDateFormatter('es_ES', \IntlDateFormatter::NONE, \IntlDateFormatter::NONE, $d->getTimezone(), \IntlDateFormatter::GREGORIAN, "EEEE d/MMM");
                                    $label = $fmt->format($d);
                                    if ($label !== false) {
                                        // remove possible trailing dots in month abbreviations (e.g. "nov.")
                                        $label = str_replace('.', '', $label);
                                        $label = mb_convert_case($label, MB_CASE_TITLE, "UTF-8"); // "Viernes 5/Nov"
                                    } else {
                                        $label = $d->format('d/m/Y');
                                    }
                                } else {
                                    $prev = setlocale(LC_TIME, 0);
                                    setlocale(LC_TIME, 'es_ES.UTF-8', 'es_ES', 'es', 'Spanish_Spain.1252');
                                    $label = strftime('%A %e/%b', $d->getTimestamp());
                                    $label = str_replace('.', '', $label);
                                    $label = mb_convert_case($label, MB_CASE_TITLE, "UTF-8");
                                    setlocale(LC_TIME, $prev);
                                }
                            } catch (Exception $e) {
                                $label = (string)$fecha;
                            }
                        ?>
                        <th class="text-center" width="200px" style="<?= $fecha == $hoy ? 'background-color:#dc573b20' : '' ?><?= $fecha == $mañana ? 'background-color:#dc573b10' : '' ?>"><span><?= htmlspecialchars($label, ENT_QUOTES, 'UTF-8') ?></span></th>
                    <?php endforeach; ?>
                    <?php endif; ?>
                </tr>
            </thead>
            <tbody>
                <?php if (!empty($reservas) && $reservas->count() > 0): ?>
                <?php foreach ($reservas as $reserva): ?>
                    <tr>
                        <td><a href="/backend/soroche/wayna/reservas/update/<?= $reserva->id ?>#primarytab-plan-de-reservas" target="_blank"><?= htmlspecialchars($reserva->name, ENT_QUOTES, 'UTF-8') ?></a></td>
                        <td class="text-center"><?= htmlspecialchars($reserva->nro_paxs, ENT_QUOTES, 'UTF-8') ?></td>
                        
                        <?php if (!empty($fechas) && is_array($fechas)): ?>
                        <?php 
                            $itinerario = $reserva->itinerarioPorFecha();
                            $servicios = $reserva->serviciosPorFecha();
                        ?>
                        <!--?= dd($itinerario) ?-->
                        <?php foreach ($fechas as $fecha): ?>
                            <td class="activity" style="<?= $fecha == $hoy ? 'background-color:#dc573b20' : '' ?><?= $fecha == $mañana ? 'background-color:#dc573b10' : '' ?>">
                            <?php if (array_key_exists($fecha, $itinerario)): ?>
                                <strong><?= $itinerario[$fecha]['dia'] ?></strong>: <?= $itinerario[$fecha]['tour'] ?>
                                <ul>
                                <?php if(array_key_exists(date('d/m/Y', strtotime($fecha)), $servicios)): ?>
                                <?php foreach($servicios[date('d/m/Y', strtotime($fecha))]['servicios'] as $servicio): ?>
                                <?php if($servicio['tipo']=='tour'): ?>
                                    <li><?= $servicio['confirmado'] ?> <?= $servicio['servicio'] ?></li>
                                <?php endif ?>
                                <?php endforeach ?>
                                <?php endif ?>
                                </ul>
                                <?= $reserva->hotelPorFecha($fecha,null) ?>
                                <ul>
                                <?php if(array_key_exists(date('d/m/Y', strtotime($fecha)), $servicios)): ?>
                                <?php foreach($servicios[date('d/m/Y', strtotime($fecha))]['servicios'] as $servicio): ?>
                                <?php if($servicio['tipo']=='hotel'): ?>
                                    <li><?= $servicio['pagado'] ?> <?= $servicio['nombre'] ?></li>
                                <?php endif ?>
                                <?php endforeach ?>
                                <?php endif ?>
                                </ul>
                            <?php endif; ?>
                            </td>
                        <?php endforeach; ?>
                        <?php endif; ?>
                    </tr>
                <?php endforeach; ?>
                <?php else: ?>
                    <tr>
                        <td colspan="<?= 2 + (is_array($fechas) ? count($fechas) : 0) ?>" class="text-center">
                            No se encontraron reservas.
                        </td>
                    </tr>
                <?php endif; ?>
        </table>
    </div>
</div>

<style>
    .activity ul{
        margin: 0 0 10px 0;
        padding: 0 0 0 15px;
    }
    .activity ul li{
        list-style-type: none;
    }
    .hoy{
        
    }
    .manana{
        background-color: #d1e7dd;
    }
</style>